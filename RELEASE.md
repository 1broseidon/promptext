# Release Process Guide

This document describes the automated release process for promptext using GoReleaser.

## Prerequisites

### 1. Create Homebrew Tap Repository

Before your first release, you need to create a Homebrew tap repository on GitHub:

1. Go to https://github.com/new
2. Create a new **public** repository named: `homebrew-tap`
3. Initialize it with a README (optional)
4. No further configuration needed - GoReleaser will automatically populate it

Your tap repository will be: `https://github.com/1broseidon/homebrew-tap`

### 2. Verify GitHub Token Permissions

The default `GITHUB_TOKEN` provided by GitHub Actions has sufficient permissions to:
- Create releases in the promptext repository
- Push to your homebrew-tap repository (if it's under the same user/org)

If you want to use a separate organization for your tap, you'll need to:
1. Create a Personal Access Token (PAT) at https://github.com/settings/tokens
2. Grant `repo` scope
3. Add it as a repository secret named `HOMEBREW_TAP_GITHUB_TOKEN`
4. Update `.goreleaser.yaml` to use it (see commented section)

## Creating a Release

The release process is fully automated via GitHub Actions when you push a git tag:

### 1. Update CHANGELOG.md

Before creating a release, update your changelog with the changes in this version:

```bash
# Edit CHANGELOG.md and add your changes under a new version section
vim CHANGELOG.md
git add CHANGELOG.md
git commit -m "docs: update changelog for v1.0.0"
```

### 2. Create and Push a Version Tag

GoReleaser triggers on git tags matching the pattern `v*`:

```bash
# Create an annotated tag with semantic versioning
git tag -a v1.0.0 -m "Release v1.0.0: Initial production release"

# Push the tag to GitHub
git push origin v1.0.0
```

**Version Format:** Follow semantic versioning (semver):
- `v1.0.0` - Major release (breaking changes)
- `v1.1.0` - Minor release (new features, backward compatible)
- `v1.1.1` - Patch release (bug fixes)
- `v1.0.0-beta.1` - Pre-release (will be marked as pre-release on GitHub)

### 3. Monitor the Release

1. Go to https://github.com/1broseidon/promptext/actions
2. Click on the "Release" workflow that was triggered
3. Watch the build process:
   - Checkout code
   - Run tests
   - Build binaries for all platforms
   - Create GitHub release
   - Update Homebrew tap
   - Generate checksums

The entire process typically takes 2-5 minutes.

### 4. Verify the Release

Once complete, verify:

**GitHub Release:**
- Visit https://github.com/1broseidon/promptext/releases
- Confirm your new release is published with:
  - Release notes (auto-generated from commits)
  - Binary assets for all platforms
  - `checksums.txt` file

**Homebrew Formula:**
- Visit https://github.com/1broseidon/homebrew-tap
- Check that `Formula/promptext.rb` was created/updated
- Verify the version matches your tag

**Test Installation:**
```bash
# Test Homebrew installation
brew tap 1broseidon/tap
brew install promptext
prx --version

# Test direct download
curl -L -o prx https://github.com/1broseidon/promptext/releases/download/v1.0.0/promptext_v1.0.0_Linux_x86_64.tar.gz
tar -xzf prx
./prx --version
```

## What Gets Released

For each release, GoReleaser creates:

### Binaries

Compiled for the following platforms:

- **Linux**: amd64, arm64, armv7
- **macOS**: amd64 (Intel), arm64 (Apple Silicon)
- **Windows**: amd64, arm64, armv7

Each binary is packaged in an archive:
- `.tar.gz` for Linux and macOS
- `.zip` for Windows

### Release Assets

- `checksums.txt` - SHA256 checksums for all archives
- Individual archives for each platform
- Source code (auto-generated by GitHub)

### Homebrew Formula

A formula is automatically created/updated in your `homebrew-tap` repository.

Users can install with:
```bash
brew tap 1broseidon/tap
brew install promptext
```

Or in a single command:
```bash
brew install 1broseidon/tap/promptext
```

### Changelog

Auto-generated from commit messages since the last release, organized by type:
- Features (commits starting with `feat:`)
- Bug Fixes (commits starting with `fix:`)
- Performance Improvements (commits starting with `perf:`)
- Refactoring (commits starting with `refactor:`)
- Documentation (commits starting with `docs:`)

## Local Testing

Before pushing a tag, you can test the release process locally:

### Install GoReleaser

```bash
# macOS
brew install goreleaser

# Go install
go install github.com/goreleaser/goreleaser/v2@latest
```

### Test Build

```bash
# Build snapshot (doesn't publish anything)
goreleaser release --snapshot --clean

# Check generated artifacts
ls -la dist/

# Test the binary
./dist/prx_linux_amd64_v1/prx --version
```

### Validate Configuration

```bash
# Check .goreleaser.yaml for errors
goreleaser check

# Preview changelog
goreleaser changelog
```

## Troubleshooting

### Release Failed: Tests Failed

If tests fail during the release workflow:
1. Fix the failing tests locally
2. Commit the fixes
3. Delete the tag: `git tag -d v1.0.0 && git push origin :refs/tags/v1.0.0`
4. Create a new tag after fixes

### Release Failed: Permission Denied to homebrew-tap

If GoReleaser can't push to homebrew-tap:
1. Verify the repository exists: https://github.com/1broseidon/homebrew-tap
2. Ensure it's public
3. Check that GITHUB_TOKEN has correct permissions
4. For cross-org taps, use a PAT instead

### Binary Won't Run: "Permission Denied"

Users need to make the binary executable:
```bash
chmod +x prx
./prx --version
```

### macOS: "prx cannot be opened because the developer cannot be verified"

This is expected for unsigned binaries. Users can bypass with:
```bash
# Option 1: Remove quarantine attribute
xattr -d com.apple.quarantine prx

# Option 2: Use Homebrew (recommended)
brew install 1broseidon/tap/promptext
```

For code signing, see: https://goreleaser.com/customization/sign/

## Release Checklist

Before creating a release:

- [ ] All tests pass locally: `go test ./...`
- [ ] CHANGELOG.md is updated with version notes
- [ ] Version follows semantic versioning
- [ ] Homebrew tap repository exists and is public
- [ ] You've tested locally with `goreleaser release --snapshot --clean`
- [ ] All new features are documented in README.md

After creating a release:

- [ ] GitHub release was created successfully
- [ ] All binary assets are present
- [ ] Homebrew formula was updated in tap repository
- [ ] Test installation via Homebrew: `brew install 1broseidon/tap/promptext`
- [ ] Test installation via direct download
- [ ] Announce release (optional: social media, discussions, etc.)

## Commit Message Convention

To get organized, readable changelogs, follow conventional commits:

```bash
# Features
git commit -m "feat: add token budget limiting with --max-tokens flag"

# Bug fixes
git commit -m "fix: correct tiktoken encoding for multi-byte characters"

# Performance improvements
git commit -m "perf: optimize file filtering for large repositories"

# Refactoring
git commit -m "refactor: extract relevance scoring into separate package"

# Documentation
git commit -m "docs: add examples for relevance filtering"

# Chores (won't appear in changelog)
git commit -m "chore: update dependencies"
git commit -m "ci: improve release workflow"
git commit -m "test: add coverage for edge cases"
```

## Version Injection

GoReleaser automatically injects version information during build:

```go
// In cmd/promptext/main.go
var (
    version = "dev"     // Replaced with git tag (e.g., "v1.0.0")
    date    = "unknown" // Replaced with build date (e.g., "2025-01-15")
)
```

Users can check version with:
```bash
prx --version
# Output: promptext version v1.0.0 (2025-01-15)
```

## Advanced: Pre-releases

To create a pre-release (beta, alpha, rc):

```bash
# Beta release
git tag -a v1.0.0-beta.1 -m "Beta release v1.0.0-beta.1"
git push origin v1.0.0-beta.1

# Release candidate
git tag -a v2.0.0-rc.1 -m "Release candidate v2.0.0-rc.1"
git push origin v2.0.0-rc.1
```

GoReleaser automatically marks these as "pre-release" on GitHub.

## Next Steps: Phase 2 & 3

After Phase 1 is working, you can expand to:

**Phase 2: Windows Package Managers**
- Scoop bucket for Windows users
- Chocolatey package

**Phase 3: Linux Package Managers**
- Native .deb packages (Debian/Ubuntu)
- Native .rpm packages (RHEL/Fedora)
- AUR package (Arch Linux)
- Snap package

See `.goreleaser.yaml` comments for configuration examples.

## Resources

- **GoReleaser Documentation**: https://goreleaser.com/
- **GitHub Actions**: https://docs.github.com/en/actions
- **Homebrew Formula Cookbook**: https://docs.brew.sh/Formula-Cookbook
- **Semantic Versioning**: https://semver.org/
- **Conventional Commits**: https://www.conventionalcommits.org/
