name: Release (Stable)

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for GoReleaser to generate changelog

      - name: Fetch all tags
        run: git fetch --force --tags

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: true

      - name: Run tests
        run: go test -v ./...

      - name: Run GoReleaser (Stable Publishers)
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean --config .goreleaser.stable.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Create release notes for README
        if: success()
        run: |
          # Extract version from tag
          VERSION=${GITHUB_REF#refs/tags/}

          cat > release-summary.md << EOF
          ## Latest Stable Release: $VERSION

          ### Installation (Verified & Working)

          **Homebrew (macOS/Linux):**
          \`\`\`bash
          brew tap 1broseidon/tap
          brew install promptext
          \`\`\`

          **Go Install (All platforms):**
          \`\`\`bash
          go install github.com/1broseidon/promptext/cmd/promptext@latest
          \`\`\`

          **Direct Install Scripts:**
          - Linux/macOS: \`curl -sSL https://raw.githubusercontent.com/1broseidon/promptext/main/scripts/install.sh | bash\`
          - Windows: \`irm https://raw.githubusercontent.com/1broseidon/promptext/main/scripts/install.ps1 | iex\`

          ### Experimental Publishers
          - **Snap**: Pending manual review in Snap Store (check back in 2-3 days)
          - **Chocolatey**: Under development

          ---
          *This summary is automatically generated from stable release workflow*
          EOF

          echo "ðŸ“ Release summary generated"
          cat release-summary.md

      - name: Post release summary as comment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('release-summary.md', 'utf8');

            // Find the release
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1
            });

            if (releases.length > 0) {
              // Add comment to release with installation instructions
              await github.rest.repos.createReleaseDiscussion({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: releases[0].id,
                body: summary
              }).catch(err => {
                console.log('Note: Could not create discussion (may not be enabled)');
              });

              console.log('âœ… Release published with stable installation instructions');
            }
