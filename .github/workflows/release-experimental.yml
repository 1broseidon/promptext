name: Release (Experimental)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # Manual trigger for testing
    inputs:
      version:
        description: 'Version tag to publish (e.g., v0.6.1)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  snap:
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't block workflow on failure
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch all tags
        run: git fetch --force --tags

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: true

      - name: Install Snapcraft
        run: |
          sudo snap install snapcraft --classic

      - name: Run GoReleaser (Snap only)
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean --config .goreleaser.experimental.yaml --skip=homebrew-casks
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}

      - name: Snap publish status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "✅ Snap published successfully"
            echo "Note: May require manual review in Snap Store (2-3 days)"
            echo "Check status: https://snapcraft.io/promptext"
          else
            echo "⚠️ Snap publishing failed - this is experimental"
            echo "Stable releases (GitHub + Homebrew) are not affected"
          fi

  chocolatey:
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't block workflow on failure
    if: false  # Disabled until Chocolatey setup is fixed
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch all tags
        run: git fetch --force --tags

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: true

      - name: Install Mono and Chocolatey
        run: |
          sudo apt-get update
          sudo apt-get install -y mono-complete

          sudo mkdir -p /opt/chocolatey
          cd /tmp
          wget -q "https://github.com/chocolatey/choco/releases/download/2.4.1/chocolatey.v2.4.1.tar.gz"
          sudo tar -xzf chocolatey.v2.4.1.tar.gz -C /opt/chocolatey

          echo '#!/bin/bash' | sudo tee /usr/local/bin/choco
          echo 'exec mono /opt/chocolatey/choco.exe "$@"' | sudo tee -a /usr/local/bin/choco
          sudo chmod +x /usr/local/bin/choco

      - name: Run GoReleaser (Chocolatey only)
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean --config .goreleaser.experimental.yaml --skip=homebrew-casks,snapcrafts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHOCOLATEY_API_KEY: ${{ secrets.CHOCOLATEY_API_KEY }}

      - name: Chocolatey publish status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "✅ Chocolatey package published"
            echo "Note: Package will enter moderation queue (1-7 days)"
            echo "Check status: https://community.chocolatey.org/packages/promptext"
          else
            echo "⚠️ Chocolatey publishing failed - this is experimental"
            echo "Stable releases (GitHub + Homebrew) are not affected"
          fi
